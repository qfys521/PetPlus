import { LogUtil } from '@pura/harmony-utils';
import { IntelCategory, knowledgeData } from '../data/knowledge';
import { display } from '@kit.ArkUI';

// å¼•å…¥è®¾å¤‡æ˜¾ç¤ºæ¨¡å—ï¼Œç”¨äºè·å–çœŸå®å±å¹•å°ºå¯¸

@Component
export struct Intel {
  // æ ¸å¿ƒæ§åˆ¶å˜é‡ï¼šæ˜¯å¦ä¸ºç§»åŠ¨ç«¯å¸ƒå±€
  @State isMobileLayout: boolean = true;

  // æ§åˆ¶â€œå›åˆ°é¡¶éƒ¨â€æŒ‰é’®çš„æ˜¾ç¤º
  @State showScrollToTop: boolean = false;
  // ç»™ä¸»è¦çš„ Scroll/List ç»‘å®šæ§åˆ¶å™¨ï¼Œç”¨äºè·³è½¬é¡¶éƒ¨
  private scroller: Scroller = new Scroller();

  // åŸå§‹æ•°æ®
  private allData: IntelCategory[] = [];
  // è§†å›¾ç»‘å®šçš„æ•°æ®
  @State displayData: IntelCategory[] = [];

  @State searchKeyword: string = '';
  @State isSearching: boolean = true;
  private searchDebounceTimer: number = -1;

  // è®°å½•å“ªäº›åˆ†ç±»å¤„äºå±•å¼€çŠ¶æ€
  @State expandedCategories: string[] = [];

  // PCå¹³æ¿ç«¯å·¦ä¾§åˆ†ç±»è¾¹æ çš„åˆ—è¡¨
  @State categoryList: string[] = ['å…¨éƒ¨'];
  @State selectedCategory: string = 'å…¨éƒ¨';

  aboutToAppear(): void {
    // 1. è·å–çœŸå®å±å¹•ç‰©ç†å®½åº¦ï¼Œé˜²æ­¢å¸ƒå±€è¯¯åˆ¤
    try {
      const displayObj = display.getDefaultDisplaySync();
      // è·å–ç‰©ç†åƒç´ å¹¶è½¬ä¸ºé€»è¾‘åƒç´  vpï¼Œæˆ–è€…ç®€å•æ¯”è¾ƒå®½é«˜
      if (displayObj.width < displayObj.height || displayObj.width < 1500) {
        // é€šå¸¸ç«–å±(å®½<é«˜)ç»å¯¹æ˜¯æ‰‹æœºã€‚æˆ–è€…ç‰©ç†åƒç´ å®½åº¦ä¸å¤Ÿå¤§ä¹Ÿæ˜¯æ‰‹æœºã€‚
        this.isMobileLayout = true;
      } else {
        this.isMobileLayout = false;
      }
    } catch (e) {
      LogUtil.error("[Intel] è·å–å±å¹•ä¿¡æ¯å¤±è´¥ï¼Œé»˜è®¤ä½¿ç”¨ç§»åŠ¨ç«¯å¸ƒå±€");
      this.isMobileLayout = true;
    }

    setTimeout((): void => {
      this.initData();
    }, 50);
  }

  private initData(): void {
    try {
      this.allData = knowledgeData as IntelCategory[];
      this.displayData = this.allData;

      const cats: string[] = ['å…¨éƒ¨'];
      this.allData.forEach((item: IntelCategory): void => {
        cats.push(this.extractShortTitle(item.title));
      });
      this.categoryList = cats;

      // å¦‚æœæ˜¯ PCï¼Œé»˜è®¤å±•å¼€ç¬¬ä¸€ä¸ª
      if (!this.isMobileLayout && this.allData.length > 0) {
        this.expandedCategories = [this.allData[0].title];
      }

      this.isSearching = false;
    } catch (e) {
      LogUtil.error("[Intel] åŠ è½½é™æ€æ•°æ®å¤±è´¥");
      this.isSearching = false;
    }
  }

  // === å±•å¼€ä¸æŠ˜å  ===
  private toggleCategory(title: string): void {
    const index = this.expandedCategories.indexOf(title);
    if (index >= 0) {
      this.expandedCategories.splice(index, 1);
    } else {
      this.expandedCategories.push(title);
    }
  }

  private isExpanded(title: string): boolean {
    return this.expandedCategories.indexOf(title) >= 0;
  }

  // === æœç´¢ä¸è¿‡æ»¤ ===
  private handleSearchFilter(): void {
    this.isSearching = true;

    if (this.searchDebounceTimer !== -1) {
      clearTimeout(this.searchDebounceTimer);
    }

    this.searchDebounceTimer = setTimeout((): void => {
      new Promise<IntelCategory[]>((resolve: (res: IntelCategory[]) => void): void => {
        let result: IntelCategory[] = this.allData;

        // åªæœ‰éç§»åŠ¨ç«¯æ‰å—å·¦ä¾§ä¾§ï¿½ï¿½æ å½±å“
        if (!this.isMobileLayout && this.selectedCategory !== 'å…¨éƒ¨') {
          result = result.filter((item: IntelCategory): boolean => this.extractShortTitle(item.title) === this.selectedCategory);
        }

        const kw = this.searchKeyword.trim().toLowerCase();

        if (kw.length > 0) {
          result = result.map((category: IntelCategory): IntelCategory => {
            const titleMatches = category.title.toLowerCase().includes(kw);
            const matchedSentences = category.subSentences.filter((sentence: string): boolean =>
            sentence.toLowerCase().includes(kw)
            );

            // å¦‚æœæœ‰æœç´¢è¯ï¼Œè‡ªåŠ¨å±•å¼€åŒ¹é…çš„åˆ†ç±»
            if (titleMatches || matchedSentences.length > 0) {
              if (this.expandedCategories.indexOf(category.title) === -1) {
                this.expandedCategories.push(category.title);
              }
            }

            return {
              title: category.title,
              subSentences: titleMatches ? category.subSentences : matchedSentences
            } as IntelCategory;
          }).filter((category: IntelCategory): boolean => category.subSentences.length > 0);
        }

        resolve(result);
      }).then((filteredData: IntelCategory[]): void => {
        this.displayData = filteredData;
        this.isSearching = false;
      });
    }, 300);
  }

  private onSearchChange(val: string): void {
    this.searchKeyword = val;
    this.handleSearchFilter();
  }

  private onCategorySelect(cat: string): void {
    if (this.selectedCategory === cat) return;
    this.selectedCategory = cat;

    if (cat !== 'å…¨éƒ¨') {
      const target = this.allData.find(item => this.extractShortTitle(item.title) === cat);
      if (target && this.expandedCategories.indexOf(target.title) === -1) {
        this.expandedCategories = [target.title];
      }
    }
    this.handleSearchFilter();
  }

  private extractShortTitle(fullTitle: string): string {
    if (!fullTitle) return "å…¶ä»–";
    let cleanTitle = fullTitle.replace(/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/, '');
    cleanTitle = cleanTitle.replace(/ï¼ˆ.*?ï¼‰/g, '');
    cleanTitle = cleanTitle.replace(/ç¯‡/g, '');
    return cleanTitle;
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Stack({ alignContent: Alignment.TopStart }) {
        Image($r('app.media.bg2'))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)

        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(255, 255, 255, 0.4)')

        Column() {
          this.HeaderSection()

          if (this.isMobileLayout) {
            // ã€ç§»åŠ¨ç«¯ã€‘ï¼šå…¨å±å®½åº¦ï¼ŒæŠ˜å å¡ç‰‡ä¸Šä¸‹æ’åˆ—
            Stack({ alignContent: Alignment.Center }) {
              this.ContentList()
              if (this.isSearching) this.LoadingIndicator()
            }
            .layoutWeight(1)
            .width('100%')
          } else {
            // ã€PC/å¹³æ¿ç«¯ã€‘ï¼šå·¦å³åŒæ å¸ƒå±€
            Row() {
              Column() {
                this.DesktopCategorySidebar()
              }
              .width(220)
              .height('100%')
              .margin({ right: 16 })

              Stack({ alignContent: Alignment.Center }) {
                this.ContentList()
                if (this.isSearching) this.LoadingIndicator()
              }
              .layoutWeight(1)
              .height('100%')
            }
            .width('100%')
            .layoutWeight(1)
            .padding({ left: 16, right: 16, bottom: 20 })
          }
        }
        .width('100%')
        .height('100%')
      }
      .width('100%')
      .height('100%')
      // ä½¿ç”¨æ›´å¯é çš„çª—å£æ‹‰ä¼¸ç›‘å¬ä½œä¸ºè¡¥å……
      .onAreaChange((oldValue: Area, newValue: Area) => {
        const w = newValue.width as number;
        const h = newValue.height as number;
        const isNowMobile = (w < 600 || h > w);
        if (this.isMobileLayout !== isNowMobile) {
          this.isMobileLayout = isNowMobile;
          this.handleSearchFilter();
        }
      })

      // === æ‚¬æµ®çš„å›åˆ°é¡¶éƒ¨æŒ‰é’® ===
      if (this.showScrollToTop) {
        Button({ type: ButtonType.Circle }) {
          SymbolGlyph($r('sys.symbol.arrow_up'))
            .fontSize(24)
            .fontColor(['#FFFFFF'])
        }
        .width(48)
        .height(48)
        .backgroundColor('#1890FF')
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.2)', offsetY: 4 })
        .margin({ right: 24, bottom: 40 })
        .transition({ type: TransitionType.All, opacity: 1, scale: { x: 0, y: 0 } })
        .onClick((): void => {
          // è°ƒç”¨ Scroller åŠ¨ç”»æ»šåŠ¨åˆ°åˆ—è¡¨æœ€é¡¶éƒ¨
          this.scroller.scrollTo({ xOffset: 0, yOffset: 0, animation: { duration: 300, curve: Curve.EaseInOut } });
        })
      }
    }
  }

  @Builder
  private HeaderSection(): void {
    Column({ space: 16 }) {
      Text("ğŸ“– å…»å® æ™ºåº“")
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .width('100%')
        .margin({ top: 20, left: 16 })

      Search({ placeholder: "è¾“å…¥å…³é”®è¯æ£€ç´¢æµ·é‡å…»å® çŸ¥è¯†..." })
        .width('90%')
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.7)')
        .borderRadius(20)
        .onChange((value: string): void => {
          this.onSearchChange(value);
        })
    }
    .width('100%')
    .padding({ bottom: 16 })
  }

  @Builder
  private DesktopCategorySidebar(): void {
    Scroll() {
      Column({ space: 8 }) {
        Text("çŸ¥è¯†åˆ†ç±»")
          .fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .width('100%').padding({ left: 12, bottom: 8 })

        ForEach(this.categoryList, (cat: string) => {
          Row() {
            Text(cat)
              .fontSize(14)
              .fontWeight(this.selectedCategory === cat ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.selectedCategory === cat ? '#1890FF' : '#555')
          }
          .width('100%').padding(12)
          .backgroundColor(this.selectedCategory === cat ? 'rgba(24, 144, 255, 0.15)' : 'transparent')
          .borderRadius(12)
          .onClick((): void => {
            this.onCategorySelect(cat);
          })
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('rgba(255, 255, 255, 0.75)')
      .borderRadius(20)
    }
    .height('100%')
    .scrollBar(BarState.Off)
  }

  @Builder
  private ContentList(): void {
    if (this.displayData.length === 0 && !this.isSearching) {
      Column({ space: 16 }) {
        SymbolGlyph($r('sys.symbol.magnifyingglass')).fontSize(60).fontColor(['#CCC'])
        Text("æœªæ‰¾åˆ°ç›¸å…³çŸ¥è¯†").fontSize(14).fontColor('#888')
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
    } else {
      // ç»‘å®š Scrollerï¼Œç›‘å¬æ»šåŠ¨äº‹ä»¶æ¥æ§åˆ¶â€œå›åˆ°é¡¶éƒ¨â€çš„æ˜¾éš
      List({ space: 16, scroller: this.scroller }) {
        ForEach(this.displayData, (category: IntelCategory) => {
          ListItem() {
            this.CategoryFoldCard(category)
          }
        })
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)
      .padding({ left: this.isMobileLayout ? 16 : 0, right: this.isMobileLayout ? 16 : 0, bottom: 20 })
      .onScroll((xOffset: number, yOffset: number): void => {
        // è·å–å½“å‰æ»šåŠ¨çš„æ€»åç§»é‡ï¼Œè‹¥å¤§äº300åˆ™æ˜¾ç¤ºæŒ‰é’®ï¼Œå¦åˆ™éšè—
        const y = this.scroller.currentOffset().yOffset;
        if (y > 300 && !this.showScrollToTop) {
          animateTo({ duration: 200 }, (): void => { this.showScrollToTop = true; });
        } else if (y <= 300 && this.showScrollToTop) {
          animateTo({ duration: 200 }, (): void => { this.showScrollToTop = false; });
        }
      })
    }
  }

  @Builder
  private CategoryFoldCard(category: IntelCategory): void {
    Column() {
      // å¤´éƒ¨ç‚¹å‡»åŒº
      Row() {
        SymbolGlyph($r('sys.symbol.doc_text')).fontSize(20).fontColor(['#1890FF']).margin({ right: 12 })

        Column({ space: 4 }) {
          Text(this.extractShortTitle(category.title))
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.Black)

          Text(`å…± ${category.subSentences.length} æ¡çŸ¥è¯†`)
            .fontSize(12)
            .fontColor('#888')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        SymbolGlyph(this.isExpanded(category.title) ? $r('sys.symbol.chevron_up') : $r('sys.symbol.chevron_down'))
          .fontSize(20)
          .fontColor(['#999'])
      }
      .width('100%')
      .padding(16)
      .backgroundColor('rgba(255, 255, 255, 0.85)')
      .borderRadius(this.isExpanded(category.title) ? { topLeft: 16, topRight: 16, bottomLeft: 0, bottomRight: 0 } : 16)
      .onClick((): void => {
        this.toggleCategory(category.title);
      })

      // å±•å¼€å†…å®¹åŒº
      if (this.isExpanded(category.title)) {
        Column({ space: 12 }) {
          ForEach(category.subSentences, (sentence: string) => {
            Row() {
              Circle({ width: 6, height: 6 }).fill('#FFB11B').margin({ top: 8, right: 10 })
              Text(sentence)
                .fontSize(15)
                .fontColor('#444')
                .lineHeight(24)
                .layoutWeight(1)
            }
            .alignItems(VerticalAlign.Top)
            .width('100%')
          })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('rgba(255, 255, 255, 0.6)')
        .borderRadius({ topLeft: 0, topRight: 0, bottomLeft: 16, bottomRight: 16 })
      }
    }
    .width('100%')
    .border({ width: 1.5, color: 'rgba(255, 255, 255, 0.8)', radius: 16 })
    .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.05)', offsetX: 0, offsetY: 4 })
    .margin({ bottom: this.isExpanded(category.title) ? 10 : 0 })
    .animation({ duration: 300, curve: Curve.EaseInOut })
  }

  @Builder
  private LoadingIndicator(): void {
    Column() {
      LoadingProgress().width(40).height(40)
      Text("æ­£åœ¨æ£€ç´¢...").fontSize(12).fontColor('#666').margin({ top: 8 })
    }
    .padding(20)
    .backgroundColor('rgba(255,255,255,0.8)')
    .borderRadius(16)
    .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)' })
  }
}
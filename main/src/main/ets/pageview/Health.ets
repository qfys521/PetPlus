import { LogUtil, PreferencesUtil, ToastUtil } from '@pura/harmony-utils';
import { getPets, getPetHealthHistory } from '../api/services';
import { McLineChart, McPieChart, Options } from '@mcui/mccharts';
import {
  PetBean,
  UserBean,
  GetPetHealthHistoryRequest,
  PetHealthHistory
} from '../api/types';

// ==== HarmonyOS NEXT (API 12+) æˆªå›¾ä¸ç³»ç»Ÿåˆ†äº«ç›¸å…³ Kit æ¨¡å— ====
import { componentSnapshot } from '@kit.ArkUI';
import { image } from '@kit.ImageKit';
import { fileIo as fs, fileUri } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';
import { systemShare } from '@kit.ShareKit';               // æ–°ç‰ˆç³»ç»Ÿåˆ†äº« Kit
import { uniformTypeDescriptor } from '@kit.ArkData';       // æ–°ç‰ˆæ ‡å‡†æ•°æ®ç±»å‹ Kit
import deviceInfo from '@ohos.deviceInfo';                  // è®¾å¤‡ä¿¡æ¯æ¨¡å—

export class PieChartData {
  value: number = 0;
  name: string = '';
  constructor(value: number, name: string) {
    this.value = value;
    this.name = name;
  }
}

@Component
export struct Health {

  @State currentBreakpoint: string = 'sm';
  @State userKey: string = '';

  @State petInfo: PetBean | null = null;
  @State healthHistoryList: PetHealthHistory[] = [];

  @State isLoading: boolean = true;
  @State isError: boolean = false;

  // æ˜¯å¦æ”¯æŒåˆ†äº«åŠŸèƒ½ï¼ˆ2in1è®¾å¤‡ä¸ºfalseï¼‰
  @State isSupportShare: boolean = true;

  @State lineOption: Options = new Options({
    xAxis: { data: ['--'] },
    yAxis: [
      { name: 'ä½“æ¸©(â„ƒ)' },
      { name: 'ä½“é‡(kg)' }
    ],
    series: [
      { name: 'ä½“æ¸©', type: 'line', data: [0] },
      { name: 'ä½“é‡', type: 'line', yAxisIndex: 1, data: [0] }
    ]
  });

  @State pieOption: Options = new Options({
    series: [{
      data: [
        new PieChartData(1, 'æš‚æ— æ•°æ®')
      ]
    }]
  });

  aboutToAppear() {
    this.initData();
  }

  private extractNumber(str: string | undefined): number {
    if (!str) return 0;
    const match = str.match(/-?\d+(\.\d+)?/);
    return match ? Number(match[0]) : 0;
  }

  private formatTime(d: Date): string {
    const pad = (n: number) => n.toString().padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  private initData() {
    try {
      const userInfoStr: string = PreferencesUtil.getStringSync("user_info", "");
      if (userInfoStr) {
        const userInfo: UserBean = JSON.parse(userInfoStr) as UserBean;
        this.userKey = userInfo.key || "";
      }
    } catch (e) {
      LogUtil.error("[Health] è§£ææœ¬åœ°ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
    }

    if (!this.userKey) {
      ToastUtil.showToast("èº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•");
      this.isError = true;
      this.isLoading = false;
      return;
    }

    this.isLoading = true;
    const now: Date = new Date();
    const halfYearAgo: Date = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);

    getPets(this.userKey).then((res: Object) => {
      if (Array.isArray(res) && res.length > 0) {
        this.petInfo = res[0] as PetBean;
      } else {
        const resRecord = res as Record<string, Object>;
        if (resRecord['list'] && Array.isArray(resRecord['list']) && resRecord['list'].length > 0) {
          this.petInfo = resRecord['list'][0] as PetBean;
        }
      }
    }).catch(() => {
      this.petInfo = {
        petName: "å¸ƒä¸",
        petSpecies: "çŒ«",
        petBreed: "è‹±çŸ­",
        currentWeight: 4.5,
        healthStatus: "å¥åº·"
      } as PetBean;
    });

    const historyParams: GetPetHealthHistoryRequest = {
      key: this.userKey,
      petId: "1",
      startTime: this.formatTime(halfYearAgo),
      endTime: this.formatTime(now),
      page: "1",
      size: "20"
    };

    getPetHealthHistory(historyParams).then((res: Object) => {
      let dataArray: PetHealthHistory[] = [];
      if (Array.isArray(res)) {
        dataArray = res as PetHealthHistory[];
      } else {
        const resRecord = res as Record<string, Object>;
        if (resRecord['list'] && Array.isArray(resRecord['list'])) {
          dataArray = resRecord['list'] as PetHealthHistory[];
        } else if (resRecord['records'] && Array.isArray(resRecord['records'])) {
          dataArray = resRecord['records'] as PetHealthHistory[];
        }
      }

      if (dataArray && dataArray.length > 0) {
        this.healthHistoryList = dataArray;
        this.updateCharts(dataArray);
      } else {
        this.loadMockHistory();
      }
    }).catch(() => {
      this.loadMockHistory();
    }).finally(() => {
      this.isLoading = false;
    });
  }

  private loadMockHistory() {
    this.healthHistoryList = [
      { recordDate: "2024-02-28", bodyWeight: "4.5", bodyTemperature: "38.5", appetiteLevel: "Excellent", vaccinationStatus: "Up-to-date", dewormingStatus: "Completed" },
      { recordDate: "2024-01-15", bodyWeight: "4.4", bodyTemperature: "38.6", appetiteLevel: "Normal", vaccinationStatus: "Up-to-date", dewormingStatus: "Completed" },
      { recordDate: "2023-12-01", bodyWeight: "4.2", bodyTemperature: "38.4", appetiteLevel: "Normal", vaccinationStatus: "Up-to-date", dewormingStatus: "Pending" }
    ];
    this.updateCharts(this.healthHistoryList);
  }

  private updateCharts(data: PetHealthHistory[]) {
    const chartData: PetHealthHistory[] = [...data].reverse();
    const dates: string[] = chartData.map(item => item.recordDate ? item.recordDate.substring(5, 10) : '');
    const temps: number[] = chartData.map(item => this.extractNumber(item.bodyTemperature));
    const weights: number[] = chartData.map(item => this.extractNumber(item.bodyWeight));

    this.lineOption.setVal({
      xAxis: { data: dates },
      series: [
        { name: 'ä½“æ¸©', data: temps },
        { name: 'ä½“é‡', data: weights }
      ]
    });

    let excellent: number = 0;
    let normal: number = 0;
    let poor: number = 0;
    data.forEach((item: PetHealthHistory) => {
      if (item.appetiteLevel === 'Excellent') excellent++;
      else if (item.appetiteLevel === 'Poor') poor++;
      else normal++;
    });

    const pieData: PieChartData[] = [];
    if (excellent > 0) pieData.push(new PieChartData(excellent, 'é£Ÿæ¬²æä½³'));
    if (normal > 0) pieData.push(new PieChartData(normal, 'é£Ÿæ¬²æ­£å¸¸'));
    if (poor > 0) pieData.push(new PieChartData(poor, 'é£Ÿæ¬²ä¸ä½³'));

    if (pieData.length > 0) {
      this.pieOption.setVal({ series: [{ data: pieData }] });
    }
  }

  // ==== æ ¸å¿ƒï¼šæˆªå›¾å¹¶ä½¿ç”¨ ShareKit è°ƒèµ·ç³»ç»Ÿåˆ†äº« ====
  private async handleShareClick(): Promise<void> {
    try {
      ToastUtil.showToast("æ­£åœ¨ç”Ÿæˆåˆ†äº«å›¾ç‰‡...");

      // 1. è·å–ç»„ä»¶å¿«ç…§
      let pixelMap: image.PixelMap = await componentSnapshot.get('share_content_area');

      // 2. å°† PixelMap æ‰“åŒ…ä¸º JPEG æ•°æ®æµ
      let imagePacker: image.ImagePacker = image.createImagePacker();
      let packOptions: image.PackingOption = { format: "image/jpeg", quality: 90 };
      let arrayBuffer: ArrayBuffer = await imagePacker.packing(pixelMap, packOptions);

      // 3. å°†å›¾ç‰‡å†™å…¥æœ¬åœ°æ²™ç®±çš„ cache ç›®å½•
      let context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
      let fileName: string = `pet_health_share_${new Date().getTime()}.jpg`;
      let filePath: string = `${context.cacheDir}/${fileName}`;
      let file: fs.File = fs.openSync(filePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC);
      fs.writeSync(file.fd, arrayBuffer);
      fs.closeSync(file);

      // 4. è·å–æ ‡å‡†åŒ– URI
      let uri: string = fileUri.getUriFromPath(filePath);

      // 5. æ„é€ æ–°ç‰ˆ systemShare æ•°æ®å¯¹è±¡
      let shareData: systemShare.SharedData = new systemShare.SharedData({
        utd: uniformTypeDescriptor.UniformDataType.JPEG,
        uri: uri
      });

      // 6. å”¤èµ·ç³»ç»ŸåŸç”Ÿåˆ†äº«é¢æ¿
      let controller: systemShare.ShareController = new systemShare.ShareController(shareData);
      controller.show(context, {
        previewMode: systemShare.SharePreviewMode.DETAIL,
        selectionMode: systemShare.SelectionMode.SINGLE
      });

    } catch (err) {
      let errMsg: string = err instanceof Error ? err.message : JSON.stringify(err);
      LogUtil.error(`åˆ†äº«æˆªå›¾å¤±è´¥: ${errMsg}`);
      ToastUtil.showToast("åˆ†äº«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
    }
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Scroll() {
        GridRow({
          breakpoints: { value: ["600vp", "840vp"], reference: BreakpointsReference.WindowSize },
          columns: { sm: 4, md: 8, lg: 12 },
          gutter: { x: 16, y: 16 }
        }) {
          GridCol({ span: { sm: 4, md: 4, lg: 4 } }) {
            Column({ space: 16 }) {
              this.HealthOverviewCard()
              this.MedicalStatusCard()
              this.AppetitePieChartCard()
            }
          }

          GridCol({ span: { sm: 4, md: 4, lg: 8 } }) {
            Column({ space: 16 }) {
              this.TrendLineChartCard()
              this.HistoryListCard()
            }
          }
        }
        .onBreakpointChange((breakpoint: string) => {
          this.currentBreakpoint = breakpoint;
        })
        .width('100%')
        .padding({ bottom: 80 })
      }
      .id('share_content_area') // æŒ‡å®šä¾›ç»„ä»¶æˆªå›¾çš„ID
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)
      .align(Alignment.Top)

      // ==== 2in1 è®¾å¤‡ä¸æ˜¾ç¤ºåˆ†äº«æ‚¬æµ®çª— ====
      if (this.isSupportShare) {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          SymbolGlyph($r('sys.symbol.share'))
            .fontSize(24)
            .fontColor([Color.White])
        }
        .width(56)
        .height(56)
        .margin({ right: 24, bottom: 48 })
        .backgroundColor('#1890FF')
        .shadow({ radius: 10, color: 'rgba(24, 144, 255, 0.4)', offsetX: 0, offsetY: 4 })
        .onClick(() => {
          this.handleShareClick();
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private HealthOverviewCard() {
    Row() {
      Column({ space: 6 }) {
        Text(this.petInfo ? `${this.petInfo.petName} çš„å¥åº·æ¡£æ¡ˆ` : "å® ç‰©å¥åº·æ¡£æ¡ˆ")
          .fontSize(14)
          .fontColor('#666666')
          .fontWeight(FontWeight.Medium)

        Row({ space: 8 }) {
          Text(this.petInfo?.currentWeight ? `${this.petInfo.currentWeight}kg` : '--')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.Black)

          Text("å½“å‰ä½“é‡")
            .fontSize(16)
            .fontColor(Color.Black)
            .margin({ top: 10 })
        }

        Text(this.petInfo?.healthStatus === 'å¥åº·' ? "ğŸ¾ æ•´ä½“çŠ¶æ€éå¸¸æ£’ï¼Œç»§ç»­ä¿æŒï¼" : "âš ï¸ éœ€è¦å¤šåŠ å…³æ³¨æ¯›å­©å­çš„çŠ¶æ€å“¦~")
          .fontSize(12)
          .fontColor('#888888')
          .maxLines(2)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      SymbolGlyph($r('sys.symbol.heart_fill'))
        .fontSize(50)
        .fontColor(this.petInfo?.healthStatus === 'å¥åº·' ? ['#FF4D4F'] : ['#FFA500'])
    }
    .rowGlassCardStyle()
  }

  @Builder
  private MedicalStatusCard() {
    Row() {
      Column({ space: 8 }) {
        SymbolGlyph($r('sys.symbol.checkmark_circle_fill'))
          .fontSize(28)
          .fontColor(this.getLatestHistory()?.vaccinationStatus === 'Up-to-date' ? ['#52C41A'] : ['#FF4D4F'])
        Text("ç–«è‹—çŠ¶æ€")
          .fontSize(12)
          .fontColor('#666666')
        Text(this.getLatestHistory()?.vaccinationStatus === 'Up-to-date' ? "å·²æ¥ç§" : "å¾…æ¥ç§")
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)

      Divider().vertical(true).height(40).color('#E5E5E5')

      Column({ space: 8 }) {
        SymbolGlyph($r('sys.symbol.star_circle_fill'))
          .fontSize(28)
          .fontColor(this.getLatestHistory()?.dewormingStatus === 'Completed' ? ['#1890FF'] : ['#FFA500'])
        Text("é©±è™«çŠ¶æ€")
          .fontSize(12)
          .fontColor('#666666')
        Text(this.getLatestHistory()?.dewormingStatus === 'Completed' ? "å·²å®Œæˆ" : "å¾…é©±è™«")
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
    }
    .rowGlassCardStyle()
  }

  @Builder
  private AppetitePieChartCard() {
    Column() {
      Text("è¿‘æœŸé£Ÿæ¬²åˆ†æ")
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .width('100%')
        .margin({ bottom: 10 })

      McPieChart({
        options: this.pieOption
      })
        .width('100%')
        .height(180)
    }
    .colGlassCardStyle()
  }

  @Builder
  private TrendLineChartCard() {
    Column() {
      Text("ä½“æ¸©ä¸ä½“é‡è¶‹åŠ¿")
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .width('100%')
        .margin({ bottom: 15 })

      McLineChart({
        options: this.lineOption
      })
        .width('100%')
        .height(220)
    }
    .colGlassCardStyle()
  }

  @Builder
  private HistoryListCard() {
    Column({ space: 12 }) {
      Text("è¿‘æœŸå¥åº·è®°å½•")
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .width('100%')

      if (this.isLoading) {
        LoadingProgress().width(30).height(30).margin(20).color('#FFB11B')
      } else if (this.healthHistoryList.length === 0) {
        Text("æš‚æ— å¥åº·è®°å½•")
          .fontSize(14)
          .fontColor('#888888')
          .margin({ top: 20, bottom: 20 })
      } else {
        ForEach(this.healthHistoryList, (item: PetHealthHistory, index: number) => {
          this.HistoryItemCard(item)
          if (index !== this.healthHistoryList.length - 1) {
            Divider().color('#E5E5E5').margin({ top: 4, bottom: 4 })
          }
        })
      }
    }
    .colGlassCardStyle()
  }

  @Builder
  private HistoryItemCard(item: PetHealthHistory) {
    Row() {
      Column({ space: 4 }) {
        Text(item.recordDate ? item.recordDate.substring(0, 10) : 'æœªçŸ¥æ—¥æœŸ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)

        Text(`é£Ÿæ¬²: ${this.translateAppetite(item.appetiteLevel)} | ä½“æ¸©: ${item.bodyTemperature || '--'}â„ƒ`)
          .fontSize(13)
          .fontColor('#666666')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Column() {
        Text(`${item.bodyWeight || '--'} kg`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1890FF')
      }
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  private getLatestHistory(): PetHealthHistory | null {
    if (this.healthHistoryList.length > 0) return this.healthHistoryList[0];
    return null;
  }

  private translateAppetite(level: string | undefined): string {
    if (level === 'Excellent') return 'æä½³';
    if (level === 'Poor') return 'ä¸ä½³';
    return 'æ­£å¸¸';
  }
}

@Extend(Column) function colGlassCardStyle() {
  .width('100%').padding(20)
  .backgroundColor('rgba(255, 255, 255, 0.55)')
  .backgroundBlurStyle(BlurStyle.Thin)
  .borderRadius(20)
  .border({ width: 1.5, color: 'rgba(255, 255, 255, 0.8)' })
  .shadow({ radius: 15, color: 'rgba(0, 0, 0, 0.05)', offsetX: 0, offsetY: 6 })
}

@Extend(Row) function rowGlassCardStyle() {
  .width('100%').padding(20)
  .backgroundColor('rgba(255, 255, 255, 0.55)')
  .backgroundBlurStyle(BlurStyle.Thin)
  .borderRadius(20)
  .border({ width: 1.5, color: 'rgba(255, 255, 255, 0.8)' })
  .shadow({ radius: 15, color: 'rgba(0, 0, 0, 0.05)', offsetX: 0, offsetY: 6 })
}